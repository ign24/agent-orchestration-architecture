{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://factor.com.ar/skill-schema.json",
  "title": "Factor Skill Schema",
  "description": "Schema for agent skills with strict validation - prevents hallucinations",
  "type": "object",
  "required": ["name", "version", "autonomy", "steps", "verification"],
  "properties": {
    "name": {
      "type": "string",
      "pattern": "^[a-z0-9-]+$",
      "description": "Skill identifier (kebab-case)"
    },
    "version": {
      "type": "string",
      "pattern": "^\\d+\\.\\d+\\.\\d+$",
      "description": "Semantic version (e.g., 1.2.3)"
    },
    "description": {
      "type": "string",
      "description": "Human-readable description"
    },
    "autonomy": {
      "type": "string",
      "enum": ["delegado", "co-pilot", "asistente"],
      "description": "Level of human confirmation required"
    },
    "context7_required": {
      "type": "array",
      "items": { "type": "string" },
      "description": "Required Context7 library IDs (e.g., /vercel/next.js)"
    },
    "pre_requisites": {
      "type": "array",
      "items": {
        "type": "object",
        "required": ["check", "args"],
        "properties": {
          "check": {
            "type": "string",
            "enum": ["command_exists", "file_exists", "env_var_set", "dir_exists"]
          },
          "args": { 
            "type": "array", 
            "items": { "type": "string" } 
          },
          "error_message": {
            "type": "string",
            "description": "Custom error message if check fails"
          }
        }
      }
    },
    "inputs": {
      "type": "object",
      "patternProperties": {
        ".*": {
          "type": "object",
          "required": ["type"],
          "properties": {
            "type": { 
              "type": "string",
              "enum": ["string", "boolean", "number", "array", "object"]
            },
            "required": { "type": "boolean", "default": false },
            "default": {},
            "description": { "type": "string" },
            "enum": { "type": "array" }
          }
        }
      }
    },
    "steps": {
      "type": "array",
      "minItems": 1,
      "items": {
        "type": "object",
        "required": ["id", "type"],
        "properties": {
          "id": { 
            "type": "string",
            "pattern": "^[a-z0-9_]+$",
            "description": "Step identifier (snake_case)"
          },
          "type": {
            "type": "string",
            "enum": ["bash", "python", "agent", "checkpoint", "mcp"]
          },
          "description": { "type": "string" },
          "cmd": { "type": "string" },
          "timeout": { 
            "type": "integer", 
            "default": 300,
            "minimum": 1,
            "maximum": 3600
          },
          "retry": { 
            "type": "integer", 
            "default": 0,
            "minimum": 0,
            "maximum": 5
          },
          "working_dir": { 
            "type": "string",
            "description": "Working directory for command execution"
          },
          "env": {
            "type": "object",
            "description": "Environment variables for this step"
          },
          "checkpoint_message": {
            "type": "string",
            "description": "Message to show at checkpoint"
          },
          "mcp_server": {
            "type": "string",
            "description": "MCP server to use (for type=mcp)"
          },
          "mcp_tool": {
            "type": "string",
            "description": "MCP tool to call"
          },
          "mcp_args": {
            "type": "object",
            "description": "Arguments for MCP tool"
          }
        }
      }
    },
    "verification": {
      "type": "array",
      "minItems": 1,
      "items": {
        "type": "object",
        "required": ["type"],
        "properties": {
          "type": {
            "type": "string",
            "enum": ["bash", "file_exists", "dir_exists", "json_valid"]
          },
          "cmd": { "type": "string" },
          "path": { "type": "string" },
          "expect_exit": { 
            "type": "integer", 
            "default": 0 
          },
          "error_message": {
            "type": "string",
            "description": "Custom error message if verification fails"
          }
        }
      }
    },
    "rollback": {
      "type": "array",
      "items": {
        "type": "object",
        "required": ["id", "cmd"],
        "properties": {
          "id": { "type": "string" },
          "cmd": { "type": "string" },
          "description": { "type": "string" }
        }
      }
    },
    "outputs": {
      "type": "object",
      "description": "Outputs produced by this skill",
      "patternProperties": {
        ".*": {
          "type": "object",
          "properties": {
            "type": { "type": "string" },
            "description": { "type": "string" }
          }
        }
      }
    },
    "metadata": {
      "type": "object",
      "properties": {
        "author": { "type": "string" },
        "created": { "type": "string", "format": "date" },
        "updated": { "type": "string", "format": "date" },
        "tags": { "type": "array", "items": { "type": "string" } }
      }
    }
  }
}
